jobs:
  - job: real_device_e2e
    pool:
      vmImage: 'macOS-10.13'
    variables:
      CI: true
      SESSION_ID: 137b7941-3285-4b94-8e1f-ae2ba3d642c3 # Temporary until Sauce RDC rolls out new solution
      REAL_DEVICE: true
      MOCHA_FILE: mocha-test-results.xml
    steps:
    - script: java -jar jars/client.jar server --manualUrl https://us1-manual.app.testobject.com --routerUrl wss://us1.api.testobject.com/api/vusb/forward &
      displayName: Start Client
    - script: |
        java -jar jars/client.jar connect --apiKey $SAUCE_LABS_RDC_API_KEY --sessionId $SESSION_ID
        adb connect localhost:7000
      displayName: Start Remote ADB
    - script: adb devices
      displayName: List Android Devices
    - task: NodeTool@0
      inputs:
        versionSpec: 11.x
    - script: npm install
      displayName: Install Node dependencies
    - script: npm run build
      displayName: Build
    - script: npx mocha --timeout 6000000 --reporter mocha-junit-reporter --recursive build/test/functional/ -g @skip-ci -i --exit
      displayName: Run tests
    - task: PublishTestResults@2
      condition: always()
      inputs:
        testResultsFiles: ${{ parameters.MOCHA_FILE }}
